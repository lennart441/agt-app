<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Atemschutzüberwachung</title>
  <link rel="stylesheet" href="style.css">
  <link rel="stylesheet" href="settings.css">
</head>
<body>
  <div id="sidebar">
    <button id="neuer-trupp-btn" onclick="window.showTruppForm()">+<br> <br>T<br>R<br>U<br>P<br>P</button>
    <button id="bericht-erstellen-btn" onclick="window.uploadToNextcloud()">B<br>E<br>R<br>I<br>C<br>H<br>T</button>
    <button id="settings-btn" onclick="window.showSettingsOverlay()">E<br>I<br>N<br>S<br"T</button>
  </div>
  <!-- <button onclick="testPressureReminderOverlay()">Test Overlay öffnen</button> -->
  <div id="main-flex-wrapper" style="display: flex; align-items: flex-start;">
    <div id="trupp-form-wrapper" style="display: none; min-width: 320px; margin-right: 32px;">
      <div class="trupp-form">
        <h2>Trupp erstellen</h2>
        <label>Truppname:</label>
        <div id="trupp-name-input" class="fake-input" onclick="showTruppNameOverlay()"></div>
        <label>Auftrag:</label>
        <div id="trupp-mission-display" class="fake-input" onclick="showMissionOverlay('create')"></div>
        <div id="trupp-members">
          <div class="trupp-member">
            <label>Truppführer Name:</label>
            <div id="tf-name" class="fake-input" onclick="showNameOverlay('tf-name')"></div>
            <label>Druck:</label>
            <div id="tf-druck" class="fake-input" onclick="showDruckOverlay('tf-druck')"></div>
          </div>
          <div class="trupp-member">
            <label>Truppmann 1 Name:</label>
            <div id="tm1-name" class="fake-input" onclick="showNameOverlay('tm1-name')"></div>
            <label>Druck:</label>
            <div id="tm1-druck" class="fake-input" onclick="showDruckOverlay('tm1-druck')"></div>
          </div>
        </div>
        <button onclick="window.addTruppMember()">+ Truppmann</button>
        <button onclick="window.createTrupp()">Trupp erstellen</button>
      </div>
    </div>
    <div style="display: flex; flex-direction: row; gap: 24px;">
      <div id="trupp-container" style="flex: 1;"></div>
      <div id="archiv-container" style="flex: 1; min-width: 350px; padding: 12px;"></div>
    </div>
  </div>

  <!-- Druck Overlay -->
  <div id="druck-overlay" style="display: none;">
    <div id="druck-content">
      <button class="close-btn" id="close-overlay">X</button>
      <h2>Druck auswählen</h2>
      <div id="druck-grid"></div>
    </div>
  </div>

  <!-- Name Overlay -->
  <div id="name-overlay" style="display: none;">
    <div id="name-content">
      <button class="close-btn" id="close-name-overlay">X</button>
      <h2>Name auswählen</h2>
      <div id="name-grid"></div>
    </div>
  </div>

  <!-- Mission Overlay -->
  <div id="mission-overlay" style="display: none;">
    <div id="mission-content">
      <button class="close-btn" id="close-mission-overlay">X</button>
      <h2>Auftrag auswählen</h2>
      <div id="mission-grid"></div>
    </div>
  </div>

  <!-- Truppname Overlay -->
  <div id="truppname-overlay" style="display: none;">
    <div id="truppname-content">
      <button class="close-btn" id="close-truppname-overlay">X</button>
      <h2>Truppname auswählen</h2>
      <div id="truppname-grid"></div>
    </div>
  </div>

  <!-- Notfall Overlay -->
  <div id="notfall-overlay" style="display: none;">
    <div id="notfall-content"></div>
  </div>

  <!-- Overlay für Mitglied hinzufügen -->
  <div id="add-member-overlay" class="overlay" style="display:none;">
    <h2>Mitglied hinzufügen</h2>
    <label>Name: <input type="text" id="add-member-name"></label>
    <label>Druck: <input type="number" id="add-member-druck" min="270"></label>
    <button id="add-member-confirm">Hinzufügen</button>
    <button onclick="closeOverlay('add-member-overlay')">Abbrechen</button>
  </div>

  <!-- Fehler-Overlay -->
  <div id="error-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:99999; justify-content:center; align-items:center;">
    <div style="background:#fff; color:#c00; padding:32px; border-radius:8px; min-width:280px; max-width:90vw; text-align:center; box-shadow:0 2px 16px rgba(0,0,0,0.2);">
      <h2>Fehler</h2>
      <div id="error-message"></div>
      <button onclick="closeErrorOverlay()" style="margin-top:16px;">Schließen</button>
    </div>
  </div>

  <!-- Erfolg-Overlay -->
  <div id="success-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:99999; justify-content:center; align-items:center;">
    <div style="background:#fff; color:#28a745; padding:32px; border-radius:8px; min-width:280px; max-width:90vw; text-align:center; box-shadow:0 2px 16px rgba(0,0,0,0.2);">
      <h2>Erfolg</h2>
      <div id="success-message"></div>
      <button onclick="closeSuccessOverlay()" style="margin-top:16px;">Schließen</button>
    </div>
  </div>

  <!-- Druck-Erinnerungs-Overlay -->
  <div id="pressure-reminder-overlay" class="overlay" style="display: none;">
    <div class="overlay-content">
        <h2>Druck-Abfrage erforderlich!</h2>
        <p>Der Trupp hat 12 Minuten erreicht. Bitte den Druck überprüfen und aktualisieren.</p>
        <button onclick="closePressureReminderOverlay()">Schließen</button>
    </div>
  </div>

  <audio id="alarm-audio" loop>
    <source src="alarm.mp3" type="audio/mpeg">
    Ihr Browser unterstützt das Audio-Element nicht.
  </audio>

  <div id="settings-overlay" class="overlay" style="display: none;">
    <div class="settings-content">
      <div class="settings-left">
        <h2>Einstellungen</h2>
        <ul id="settings-list">
          <li data-setting="token" class="settings-item selected">Token ändern</li>
          <li data-setting="device" class="settings-item">Gerätename ändern</li>
          <li data-setting="takeover" class="settings-item">Übernahmeantrag</li>
          <li data-setting="offline" class="settings-item">Offline-Modus</li>
          <li data-setting="reset" class="settings-item">RESET</li>
        </ul>
      </div>
      <div class="settings-right" id="settings-detail">
        <div id="setting-token" class="setting-panel">
          <label for="settings-token-input">Neues Token eingeben:</label>
          <input type="text" id="settings-token-input" value="">
          <button id="settings-token-save">Speichern</button>
        </div>
        <div id="setting-device" class="setting-panel" style="display:none;">
          <label for="settings-device-input">Neuer Gerätename eingeben:</label>
          <input type="text" id="settings-device-input" value="">
          <button id="settings-device-save">Speichern</button>
        </div>
        <div id="setting-takeover" class="setting-panel" style="display:none;">
          <label>Übernahmeantrag stellen:</label>
          <div id="settings-takeover-uuid-list"></div>
          <button id="settings-takeover-send" disabled>Antrag senden</button>
        </div>
        <div id="setting-offline" class="setting-panel" style="display:none;">
          <h3>Offline-Modus</h3>
          <p>Im Offline-Modus wird die gesamte Serverkommunikation deaktiviert. Truppdaten werden nur lokal gespeichert und synchronisiert, Übernahmeanträge sind nicht möglich, und Berichte werden als Download angeboten.</p>
          <label class="switch">
            <input type="checkbox" id="offline-mode-switch">
            <span class="slider round"></span>
          </label>
          <span id="offline-mode-status" style="margin-left:12px; font-weight:bold;">Online</span>
        </div>
        <div id="setting-reset" class="setting-panel" style="display:none;">
          <h3>Reset-Optionen</h3>
          <p><strong>Reset Local Storage:</strong> Löscht alle gespeicherten Daten im Local Storage (z. B. Truppdaten, Gerätename, UUID). Die Seite wird anschließend neu geladen, um Änderungen anzuwenden. Dies ist nützlich, um lokale Daten zu bereinigen, ohne den Cache zu beeinflussen.</p>
          <button id="reset-local-storage-btn" style="background:#ffc107; color:#000; padding:10px 20px; border:none; border-radius:4px; cursor:pointer; margin-bottom:20px;">Reset Local Storage</button>
          <p><strong>Reset All:</strong> Löscht Local Storage, Service Worker Cache und andere temporäre Browser-Daten (z. B. Cached Assets für Offline-Nutzung). Die Seite wird neu geladen. Verwenden Sie dies, um eine vollständige Bereinigung durchzuführen, z. B. nach Updates oder Fehlern.</p>
          <button id="reset-all-btn" style="background:#dc3545; color:#fff; padding:10px 20px; border:none; border-radius:4px; cursor:pointer;">Reset All</button>
        </div>
      </div>
      <button id="settings-close-btn" class="close-btn">×</button>
    </div>
  </div>

  <!-- Takeover Overlay -->
  <div id="takeover-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); z-index:10002; align-items:center; justify-content:center;">
    <div style="background:#fff;padding:2em 2.5em;border-radius:10px;box-shadow:0 2px 16px rgba(0,0,0,0.18);min-width:320px;text-align:center;">
      <h2>Übernahmeantrag</h2>
      <p><strong>Gerät:</strong> <span id="takeover-device-name"></span></p>
      <p><strong>UUID:</strong> <span id="takeover-device-uuid"></span></p>
      <div style="margin-top:2em;">
        <button id="takeover-confirm-btn" style="background:#28a745;color:#fff;padding:0.7em 1.5em;border:none;border-radius:6px;font-size:1em;margin-right:1em;cursor:pointer;">Annehmen</button>
        <button id="takeover-decline-btn" style="background:#dc3545;color:#fff;padding:0.7em 1.5em;border:none;border-radius:6px;font-size:1em;cursor:pointer;">Ablehnen</button>
      </div>
    </div>
  </div>

  <!-- Takeover Loading Overlay -->
  <div id="takeover-loading-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.6); z-index:10003; align-items:center; justify-content:center;">
    <div style="background:#fff;padding:2em 2.5em;border-radius:10px;box-shadow:0 2px 16px rgba(0,0,0,0.18);min-width:320px;text-align:center;">
      <div style="margin-bottom:1.5em;">
        <div class="spinner" style="width:48px;height:48px;margin:auto;border:6px solid #eee;border-top:6px solid #007bff;border-radius:50%;animation:spin 1s linear infinite;"></div>
      </div>
      <h2>Warte auf Bestätigung...</h2>
      <p>Der Übernahmeantrag wurde gesendet.<br>Bitte warte auf die Antwort des aktuellen Geräts.</p>
    </div>
    <style>@keyframes spin { 100% { transform: rotate(360deg); } }</style>
  </div>

  <!-- Takeover Confirmation Overlay -->
  <div id="takeover-confirmation-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.5); z-index:10004; align-items:center; justify-content:center;">
    <div style="background:#fff; color:#007bff; padding:32px; border-radius:8px; min-width:280px; max-width:90vw; text-align:center; box-shadow:0 2px 16px rgba(0,0,0,0.2);">
      <h2 id="takeover-confirmation-title">Bestätigung</h2>
      <div id="takeover-confirmation-message"></div>
      <button onclick="document.getElementById('takeover-confirmation-overlay').style.display='none'" style="margin-top:16px;">Schließen</button>
    </div>
  </div>

  <!-- Initial Setup Overlay -->
  <div id="initial-setup-overlay" style="display:none; position:fixed; top:0; left:0; width:100vw; height:100vh; background:rgba(0,0,0,0.7); z-index:10000; justify-content:center; align-items:center;">
    <div style="background:#fff; padding:32px; border-radius:8px; min-width:280px; max-width:90vw; text-align:center; box-shadow:0 2px 16px rgba(0,0,0,0.2);">
      <h2>Ersteinrichtung</h2>
      <p>Bitte geben Sie einen Namen für dieses Gerät ein:</p>
      <input type="text" id="initial-device-name" placeholder="Gerätename" style="width:100%; padding:8px; margin:16px 0;">
      <button id="initial-save-btn" style="background:#007bff; color:white; border:none; padding:10px 20px; border-radius:4px; cursor:pointer;">Speichern</button>
    </div>
  </div>

  <!-- Overlay: Trupp bearbeiten -->
  <div id="edit-trupp-overlay" class="overlay" style="display:none;">
    <div class="overlay-content" style="max-width:500px;">
      <h2>Trupp bearbeiten</h2>
      <label>Truppname:</label>
      <div id="edit-truppname" class="fake-input" onclick="showTruppNameOverlay('edit-truppname')"></div>
      <label>Auftrag:</label>
      <div id="edit-mission" class="fake-input" onclick="showMissionOverlay('edit', null)"></div>
      <div id="edit-members"></div>
      <button id="edit-trupp-save-btn">Speichern</button>
      <button onclick="closeEditTruppOverlay()">Abbrechen</button>
    </div>
  </div>

  <script src="logic.js"></script>
  <script src="localStorage.js"></script>
  <script src="dataTakeover.js"></script>
  <script src="eventlistener.js"></script>
  <script src="overlays.js"></script>
  <script src="ui.js"></script>
  <script src="report.js"></script>
  <script src="lib/jspdf.umd.min.js"></script>
  <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('/v1/client/sw.js')
        .then(reg => console.log('Service Worker registered:', reg))
        .catch(err => console.error('Service Worker registration failed:', err));
    }
  </script>
</body>
</html>